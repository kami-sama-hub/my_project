<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é’è›™å¿«é€’ - åå°ç®¡ç†</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background-color: #f8f9fa; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .stats { display: flex; justify-content: space-between; background: #007bff; color: white; padding: 10px; border-radius: 8px; font-size: 18px; margin-top: 20px; }
        input, button { padding: 12px; margin: 10px 0; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
        button { background: #008CBA; color: white; border: none; font-weight: bold; cursor: pointer; }
        button:hover { background: #005f73; }
        table { width: 100%; margin-top: 20px; border-collapse: collapse; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: center; font-size: 16px; }
        th { background-color: #007bff; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        .search-box { display: flex; gap: 10px; margin-top: 10px; }
        .pagination { margin-top: 20px; }
        .pagination button { margin: 5px; padding: 8px 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ é’è›™å¿«é€’åå°ç®¡ç†</h1>

        <h3>ğŸ“¦ å½•å…¥æ–°çš„å¿«é€’ä¿¡æ¯</h3>
        <input type="text" id="trackingNumber" placeholder="è¯·è¾“å…¥å¿«é€’å•å·">
        <input type="text" id="status" placeholder="è¯·è¾“å…¥å¿«é€’çŠ¶æ€">
        <button onclick="addParcel()">æäº¤</button>
        <p id="message"></p>

        <h3>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h3>
        <div class="stats">
            <span>æ€»å•é‡: <b id="totalOrders">0</b></span>
            <span>å¤„ç†ä¸­: <b id="inProcess">0</b></span>
            <span>å·²å‘è´§: <b id="shipped">0</b></span>
        </div>

        <h3>ğŸ“‹ å¿«é€’ä¿¡æ¯åˆ—è¡¨</h3>
        <div class="search-box">
            <input type="text" id="search" placeholder="æœç´¢å¿«é€’å•å·">
            <button onclick="exportData()">ğŸ“¤ å¯¼å‡º CSV</button>
            <button onclick="deleteSelected()">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th><input type="checkbox" onclick="toggleAll(this)"></th>
                    <th>å¿«é€’å•å·</th>
                    <th>çŠ¶æ€</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="parcelList"></tbody>
        </table>

        <div class="pagination">
            <button onclick="prevPage()">â¬…ï¸ ä¸Šä¸€é¡µ</button>
            <span>å½“å‰é¡µ: <b id="currentPage">1</b></span>
            <button onclick="nextPage()">â¡ï¸ ä¸‹ä¸€é¡µ</button>
        </div>

        <button onclick="logout()" style="margin-top: 20px;">é€€å‡ºç™»å½•</button>
    </div>

    <script>
        let currentPage = 1;
        const limit = 10;

        async function addParcel() {
            const trackingNumber = document.getElementById("trackingNumber").value.trim();
            const status = document.getElementById("status").value.trim();

            if (!trackingNumber || !status) return alert("âŒ å¿«é€’å•å·å’ŒçŠ¶æ€ä¸èƒ½ä¸ºç©ºï¼");

            try {
                const response = await fetch("/add", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ trackingNumber, status })
                });

                const result = await response.json();
                alert(result.message);
                loadParcels();
            } catch (error) {
                alert("âŒ å½•å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œï¼");
            }
        }

        async function loadParcels(page = 1) {
            try {
                const response = await fetch(`/deliveries?page=${page}&limit=${limit}`);
                const { total, parcels } = await response.json();

                document.getElementById("totalOrders").innerText = total;
                document.getElementById("currentPage").innerText = page;

                let rows = '';
                parcels.forEach(parcel => {
                    rows += `<tr>
                        <td><input type="checkbox" value="${parcel.trackingNumber}"></td>
                        <td>${parcel.trackingNumber}</td>
                        <td>${parcel.status}</td>
                        <td><button onclick="deleteParcel('${parcel.trackingNumber}')">åˆ é™¤</button></td>
                    </tr>`;
                });

                document.getElementById('parcelList').innerHTML = rows;
            } catch (error) {
                alert("âŒ æ— æ³•åŠ è½½å¿«é€’æ•°æ®ï¼");
            }
        }

        async function deleteParcel(trackingNumber) {
            try {
                await fetch(`/delete-batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ trackingNumbers: [trackingNumber] })
                });
                loadParcels();
            } catch (error) {
                alert("âŒ åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨ï¼");
            }
        }

        async function deleteSelected() {
            const selected = Array.from(document.querySelectorAll("tbody input[type=checkbox]:checked"))
                .map(cb => cb.value);

            if (selected.length === 0) return alert("è¯·é€‰æ‹©è¦åˆ é™¤çš„è®¢å•ï¼");

            try {
                await fetch('/delete-batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ trackingNumbers: selected })
                });
                loadParcels();
            } catch (error) {
                alert("âŒ æ‰¹é‡åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨ï¼");
            }
        }

        async function exportData() {
            window.location.href = '/export?format=csv';
        }

        function toggleAll(source) {
            document.querySelectorAll("tbody input[type=checkbox]").forEach(cb => cb.checked = source.checked);
        }

        async function logout() {
            await fetch("/logout");
            window.location.reload();
        }

        window.onload = function () {
            loadParcels();
        };
    </script>
</body>
</html>
